```java
为了方便代码阅读,方法中的异常就不列出来了

基于同步发送进行源码解析
DefaultMQProducer producer = new DefaultMQProducer(PRODUCER_GROUP);
producer.setNamesrvAddr("localhost:9876");
producer.start();
Message msg = new Message(TOPIC_NAME, "",  "Hello World".getBytes());
SendResult sendResult = producer.send(msg);
producer.shutdown();
```

---

### 相关类

#### DefaultMQProducer

```java
public class DefaultMQProducer extends ClientConfig implements MQProducer {
	protected final transient DefaultMQProducerImpl defaultMQProducerImpl;
  private String producerGroup;
  private volatile int defaultTopicQueueNums = 4; //队列数量
  
  public DefaultMQProducer(final String producerGroup) {
    this(null, producerGroup, null);
  }
  
	public DefaultMQProducer(final String namespace, final String producerGroup, RPCHook rpcHook) {
  	this.producerGroup = producerGroup;
  	defaultMQProducerImpl = new DefaultMQProducerImpl(this, rpcHook);
	}
}
```

#### DefaultMQProducerImpl

```java
public class DefaultMQProducerImpl implements MQProducerInner {
  private final DefaultMQProducer defaultMQProducer;
  //键值对:Topic,TopicPublishInfo
  private final ConcurrentMap<String, TopicPublishInfo> topicPublishInfoTable = new ConcurrentHashMap<String, TopicPublishInfo>();
  private MQClientInstance mQClientFactory;

  public DefaultMQProducerImpl(final DefaultMQProducer defaultMQProducer, RPCHook rpcHook) {
    this.defaultMQProducer = defaultMQProducer;
  }
}
```

#### MQClientInstance

```java
public class MQClientInstance {
  //键值对:Group,MQProducerInner
  private final ConcurrentMap<String, MQProducerInner> producerTable = new ConcurrentHashMap<String, MQProducerInner>();
  private final MQClientAPIImpl mQClientAPIImpl;
  //键值对:Topic,TopicRouteData
  private final ConcurrentMap<String, TopicRouteData> topicRouteTable = new ConcurrentHashMap<String, TopicRouteData>();
  
  public MQClientInstance(ClientConfig clientConfig, int instanceIndex, String clientId, RPCHook rpcHook) {
    this.mQClientAPIImpl = new MQClientAPIImpl(this.nettyClientConfig, this.clientRemotingProcessor, rpcHook, clientConfig);
    if (this.clientConfig.getNamesrvAddr() != null) {
      this.mQClientAPIImpl.updateNameServerAddressList(this.clientConfig.getNamesrvAddr());
    }
    this.pullMessageService = new PullMessageService(this);
  }
}
```

#### MQClientAPIImpl

```java
public class MQClientAPIImpl {
	private final RemotingClient remotingClient;
}
```

#### TopicPublishInfo

```java
public class TopicPublishInfo {
  private List<MessageQueue> messageQueueList = new ArrayList<MessageQueue>();
  private volatile ThreadLocalIndex sendWhichQueue = new ThreadLocalIndex();
  private TopicRouteData topicRouteData;
}
```

#### TopicRouteData

```java
public class TopicRouteData extends RemotingSerializable {
	private List<QueueData> queueDatas;
  private List<BrokerData> brokerDatas;
}
```

#### QueueData

```java
public class QueueData implements Comparable<QueueData> {
	//"dlinkaCGdeMacBook-Pro.local"
  private String brokerName;
  //"4"
  private int readQueueNums;
  //"4"
  private int writeQueueNums;
  //"6"
  private int perm;
}
```

#### BrokerData

```java
public class BrokerData implements Comparable<BrokerData> {
	//"DefaultCluster"
  private String cluster;
	//"dlinkaCGdeMacBook-Pro.local"
  private String brokerName;
  //brokerId:"0",broker address:"10.0.161.163:10911"
  private HashMap<Long, String> brokerAddrs;
}
```

#### MessageQueue

```java
public class MessageQueue implements Comparable<MessageQueue>, Serializable {
	private String topic;
	private String brokerName;
	private int queueId;
}
```

---

### 源码解析

#### 1.DefaultMQProducer#start

```java
public void start() {
  this.defaultMQProducerImpl.start();
}
↓
↓
//DefaultMQProducerImpl#start
public void start() {
  this.start(true);
}
↓
↓
//DefaultMQProducerImpl#start
public void start(final boolean startFactory) {
  switch (this.serviceState) {
    case CREATE_JUST:
      
      this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQProducer, rpcHook); //2
			
      //MQClientInstance#producerTable
      boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);
      
      if (startFactory) {
        mQClientFactory.start(); //3
      }
      break;
  }
}
```

#### 2.MQClientManager#getOrCreateMQClientInstance

```java
public MQClientInstance getOrCreateMQClientInstance(final ClientConfig clientConfig, RPCHook rpcHook) {
  //IP@PID
  String clientId = clientConfig.buildMQClientId();
  MQClientInstance instance = this.factoryTable.get(clientId);
  if (null == instance) {
    //创建MQClientInstance
    instance = new MQClientInstance(clientConfig.cloneClientConfig(),
                                    this.factoryIndexGenerator.getAndIncrement(),
                                    clientId,
                                    rpcHook);
  }
  return instance;
}
```

#### 3.MQClientInstance#start

```java
public void start() {
  switch (this.serviceState) {
    case CREATE_JUST:
      this.mQClientAPIImpl.start();
      this.pullMessageService.start();
      break;
  } 
}
```

---
