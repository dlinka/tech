```java
为了方便代码阅读,方法中的异常就不列出来了

基于同步发送进行源码解析
DefaultMQProducer producer = new DefaultMQProducer(PRODUCER_GROUP);
producer.setNamesrvAddr("localhost:9876");
producer.start();
Message msg = new Message(TOPIC_NAME, "",  "Hello World".getBytes());
SendResult sendResult = producer.send(msg);
producer.shutdown();
```

---

#### 1.DefaultMQProducer的构造函数

```java
public DefaultMQProducer(final String producerGroup) {
  this(null, producerGroup, null);
}
↓
↓
public DefaultMQProducer(final String namespace, final String producerGroup, RPCHook rpcHook) {
  this.producerGroup = producerGroup;
  defaultMQProducerImpl = new DefaultMQProducerImpl(this, rpcHook);
}
```

#### 2.DefaultMQProducerImpl的构造函数

```java
public DefaultMQProducerImpl(final DefaultMQProducer defaultMQProducer, RPCHook rpcHook) {
  this.defaultMQProducer = defaultMQProducer;
  //定义阻塞队列
  this.asyncSenderThreadPoolQueue = new LinkedBlockingQueue<Runnable>(50000);
  //定义线程池
  this.defaultAsyncSenderExecutor = new ThreadPoolExecutor(
    Runtime.getRuntime().availableProcessors(), Runtime.getRuntime().availableProcessors(),
    1000 * 60, TimeUnit.MILLISECONDS,
    this.asyncSenderThreadPoolQueue,
    new ThreadFactory() {
      private AtomicInteger threadIndex = new AtomicInteger(0);
      @Override
      public Thread newThread(Runnable r) {
        return new Thread(r, "AsyncSenderExecutor_" + this.threadIndex.incrementAndGet());
      }
    });
}
```

#### 3.DefaultMQProducer#start

```java
public void start() {
  this.defaultMQProducerImpl.start();
}
```

#### 4.DefaultMQProducerImpl#start

```java
public void start() {
  this.start(true);
}
↓
↓
public void start(final boolean startFactory) {
  switch (this.serviceState) {
    case CREATE_JUST:
      this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQProducer, rpcHook); //5
			//MQClientInstance#producerTable
      boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);
      if (startFactory) {
        mQClientFactory.start(); //6
      }
      break;
  }
}
```

#### 5.MQClientManager#getOrCreateMQClientInstance

```java
public MQClientInstance getOrCreateMQClientInstance(final ClientConfig clientConfig, RPCHook rpcHook) {
  //"ip@pid"
  String clientId = clientConfig.buildMQClientId();
  MQClientInstance instance = this.factoryTable.get(clientId);
  if (null == instance) {
    //构造MQClientInstance
    instance = new MQClientInstance(clientConfig.cloneClientConfig(),
                                    this.factoryIndexGenerator.getAndIncrement(),
                                    clientId,
                                    rpcHook);
    
    MQClientInstance prev = this.factoryTable.putIfAbsent(clientId, instance);
  }
  return instance;
}
↓
↓
//MQClientInstance的构造函数
public MQClientInstance(ClientConfig clientConfig, int instanceIndex, String clientId, RPCHook rpcHook) {
	this.mQClientAPIImpl = new MQClientAPIImpl(this.nettyClientConfig, this.clientRemotingProcessor, rpcHook, clientConfig);
  if (this.clientConfig.getNamesrvAddr() != null) {
    this.mQClientAPIImpl.updateNameServerAddressList(this.clientConfig.getNamesrvAddr());
  }
  this.pullMessageService = new PullMessageService(this);
}
```

#### 6.MQClientInstance#start

```java
public void start() {
  switch (this.serviceState) {
    case CREATE_JUST:
      this.mQClientAPIImpl.start();
      this.pullMessageService.start();
      break;
  } 
}
```



---
