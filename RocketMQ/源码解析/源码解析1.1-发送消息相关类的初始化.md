```java
为了方便代码阅读,方法中的异常就不列出来了

基于同步发送进行源码解析
DefaultMQProducer producer = new DefaultMQProducer(PRODUCER_GROUP);
producer.setNamesrvAddr("localhost:9876");
producer.start();
Message msg = new Message(TOPIC_NAME, "",  "Hello World".getBytes());
SendResult sendResult = producer.send(msg);
producer.shutdown();
```

---

#### 1.DefaultMQProducer的构造函数

```java
public DefaultMQProducer(final String producerGroup) {
  this(null, producerGroup, null);
}
↓
↓
public DefaultMQProducer(final String namespace, final String producerGroup, RPCHook rpcHook) {
  this.producerGroup = producerGroup;
  defaultMQProducerImpl = new DefaultMQProducerImpl(this, rpcHook);
}
```

#### 2.DefaultMQProducerImpl的构造函数

```java
public DefaultMQProducerImpl(final DefaultMQProducer defaultMQProducer, RPCHook rpcHook) {
  this.defaultMQProducer = defaultMQProducer;
  //定义阻塞队列
  this.asyncSenderThreadPoolQueue = new LinkedBlockingQueue<Runnable>(50000);
  //定义线程池
  this.defaultAsyncSenderExecutor = new ThreadPoolExecutor(
    Runtime.getRuntime().availableProcessors(),
    Runtime.getRuntime().availableProcessors(),
    1000 * 60,
    TimeUnit.MILLISECONDS,
    this.asyncSenderThreadPoolQueue,
    new ThreadFactory() {
      private AtomicInteger threadIndex = new AtomicInteger(0);
      @Override
      public Thread newThread(Runnable r) {
        return new Thread(r, "AsyncSenderExecutor_" + this.threadIndex.incrementAndGet());
      }
    });
}
```

#### 3.DefaultMQProducer#start

```java
public void start() {
  this.defaultMQProducerImpl.start();
}
```

#### 4.DefaultMQProducerImpl#start

```java
public void start() {
  this.start(true);
}
↓
↓
public void start(final boolean startFactory) {
  switch (this.serviceState) {
    case CREATE_JUST:
      this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQProducer, rpcHook);
      
      if (startFactory) {
        mQClientFactory.start();
      }
      
      this.serviceState = ServiceState.RUNNING;
      break;
  }
}
```

#### 5.MQClientManager#getOrCreateMQClientInstance

```java
```

















#### 1.DefaultMQProducer#send

```java
public SendResult send(Message msg) {
  return this.defaultMQProducerImpl.send(msg);
}
```

#### 2.DefaultMQProducerImpl#send

```java
public SendResult send(Message msg) {
  return send(msg, this.defaultMQProducer.getSendMsgTimeout());
}
↓
↓
public SendResult send(Message msg, long timeout) {
  //同步发送
  return this.sendDefaultImpl(msg, CommunicationMode.SYNC, null, timeout);
}
↓
↓
private SendResult sendDefaultImpl(Message msg,
                                   final CommunicationMode communicationMode,
                                   final SendCallback sendCallback,
                                   final long timeout) {
	TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic()); //3
  if (topicPublishInfo != null && topicPublishInfo.ok()) {
  	MessageQueue mqSelected = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName); //4
    if (mqSelected != null) {
    	sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout - costTime);
    }
  }
}
```

#### 3.DefaultMQProducerImpl#tryToFindTopicPublishInfo

```java
private TopicPublishInfo tryToFindTopicPublishInfo(final String topic) {
	TopicPublishInfo topicPublishInfo = this.topicPublishInfoTable.get(topic);
  if (null == topicPublishInfo || !topicPublishInfo.ok()) {
    this.topicPublishInfoTable.putIfAbsent(topic, new TopicPublishInfo());
    this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic); //3.1
    topicPublishInfo = this.topicPublishInfoTable.get(topic);
  }
}
↓
↓
public boolean updateTopicRouteInfoFromNameServer(final String topic) {
  return updateTopicRouteInfoFromNameServer(topic, false, null);
}
↓
↓
public boolean updateTopicRouteInfoFromNameServer(final String topic, boolean isDefault, DefaultMQProducer defaultMQProducer) {
	TopicRouteData topicRouteData = this.mQClientAPIImpl.getTopicRouteInfoFromNameServer(topic, 1000 * 3);
}
```

### 3.1





2.DefaultMQProducerImpl#tryToFindTopicPublishInfo

```java
this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);
↓
↓
return updateTopicRouteInfoFromNameServer(topic, false, null);
↓
↓
TopicPublishInfo publishInfo = topicRouteData2TopicPublishInfo(topic, topicRouteData);
↓
↓
TopicPublishInfo info = new TopicPublishInfo();
...
MessageQueue mq = new MessageQueue(topic, qd.getBrokerName(), i);
info.getMessageQueueList().add(mq);
```

3.DefaultMQProducerImpl#selectOneMessageQueue

```java
return this.mqFaultStrategy.selectOneMessageQueue(tpInfo, lastBrokerName);
↓
↓
return tpInfo.selectOneMessageQueue(lastBrokerName);
↓
↓
if (lastBrokerName == null) {
    return selectOneMessageQueue();
}
↓
↓
int index = this.sendWhichQueue.getAndIncrement();
int pos = Math.abs(index) % this.messageQueueList.size();
//负载均衡选择第二步中创建的MessageQueue
return this.messageQueueList.get(pos);
```

4.DefaultMQProducerImpl#sendKernelImpl

```java
//地址
String brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());
...
//参数
SendMessageRequestHeader requestHeader = new SendMessageRequestHeader();
requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());
requestHeader.setTopic(msg.getTopic());
...
sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage(
                        brokerAddr,
                        mq.getBrokerName(),
                        msg,
                        requestHeader,
                        timeout - costTimeSync,
                        communicationMode,
                        context,
                        this);
↓
↓
return sendMessage(addr, brokerName, msg, requestHeader, timeoutMillis, communicationMode, null, null, null, 0, context, producer);
↓
↓
SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);
request = RemotingCommand.createRequestCommand(msg instanceof MessageBatch ? RequestCode.SEND_BATCH_MESSAGE : RequestCode.SEND_MESSAGE_V2, requestHeaderV2);
...
return this.sendMessageSync(addr, brokerName, msg, timeoutMillis - costTimeSync, request);
↓
↓
//发送请求
RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);
return this.processSendResponse(brokerName, msg, response);
```

---
